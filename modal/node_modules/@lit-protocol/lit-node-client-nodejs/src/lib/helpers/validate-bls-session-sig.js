"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.blsSessionSigVerify = void 0;
const ethers_1 = require("ethers");
const siwe_1 = require("siwe");
const LIT_SESSION_SIGNED_MESSAGE_PREFIX = 'lit_session:';
/**
 * Verifies a BLS session signature.
 *
 * @param {Function} verifier - A wasm function that takes a public key, message, and signature to verify.
 * @param {string} networkPubKey - The public key of the network.
 * @param {AuthSig} authSig
 * @typedef {Object} AuthSig
 * @property {string} sig - The signature in string format.
 * @property {string} signedMessage - The message that was signed.
 */
const blsSessionSigVerify = async (verifier, networkPubKey, authSig, authSigSiweMessage) => {
    let sigJson = JSON.parse(authSig.sig);
    // we do not nessesarly need to use ethers here but was a quick way
    // to get verification working.
    const eip191Hash = ethers_1.ethers.utils.hashMessage(authSig.signedMessage);
    const prefixedStr = LIT_SESSION_SIGNED_MESSAGE_PREFIX + eip191Hash.replace('0x', '');
    const prefixedEncoded = ethers_1.ethers.utils.toUtf8Bytes(prefixedStr);
    const shaHashed = ethers_1.ethers.utils.sha256(prefixedEncoded).replace('0x', '');
    const signatureBytes = Buffer.from(sigJson.ProofOfPossession, `hex`);
    /** Check time or now */
    const checkTime = new Date();
    if (!authSigSiweMessage.expirationTime || !authSigSiweMessage.issuedAt) {
        throw new Error('Invalid SIWE message. Missing expirationTime or issuedAt.');
    }
    // check timestamp of SIWE
    const expirationDate = new Date(authSigSiweMessage.expirationTime);
    if (checkTime.getTime() >= expirationDate.getTime()) {
        throw new siwe_1.SiweError(siwe_1.SiweErrorType.EXPIRED_MESSAGE, `${checkTime.toISOString()} < ${expirationDate.toISOString()}`, `${checkTime.toISOString()} >= ${expirationDate.toISOString()}`);
    }
    const issuedAt = new Date(authSigSiweMessage.issuedAt);
    if (checkTime.getTime() < issuedAt.getTime()) {
        throw new siwe_1.SiweError(siwe_1.SiweErrorType.NOT_YET_VALID_MESSAGE, `${checkTime.toISOString()} >= ${issuedAt.toISOString()}`, `${checkTime.toISOString()} < ${issuedAt.toISOString()}`);
    }
    await verifier(networkPubKey, Buffer.from(shaHashed, 'hex'), signatureBytes);
};
exports.blsSessionSigVerify = blsSessionSigVerify;
//# sourceMappingURL=validate-bls-session-sig.js.map